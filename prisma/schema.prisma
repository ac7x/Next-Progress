generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                  String         @id @default(auto()) @map("_id") @db.ObjectId
  userId              String         @unique
  displayName         String
  pictureUrl          String?
  statusMessage       String?
  role                RoleEnum       @default(USER)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // é—œè¯
  userAsset           UserAsset?
  assetMutations      AssetMutation[]
  linePayments        LinePay[]
  createdProjects     ProjectInstance[] @relation("UserCreatedProjects") // æ›´æ–°æ¨¡å‹åç¨±
  projectMemberships  ProjectMember[]
  engineerings        EngineeringInstance[] // æ›´æ–°æ¨¡å‹åç¨±
}

enum RoleEnum {
  USER
  ADMIN
}

enum TagType {
  GENERAL
  PROJECT_INSTANCE
  PROJECT_TEMPLATE
  ENGINEERING_INSTANCE
  ENGINEERING_TEMPLATE
  TASK_INSTANCE
  TASK_TEMPLATE
  SUBTASK_INSTANCE
  SUBTASK_TEMPLATE
  WAREHOUSE_INSTANCE
  WAREHOUSE_ITEM
}

enum TagRelationType {
  PROJECT_INSTANCE
  PROJECT_TEMPLATE
  ENGINEERING_INSTANCE
  ENGINEERING_TEMPLATE
  TASK_INSTANCE
  TASK_TEMPLATE
  SUBTASK_INSTANCE
  SUBTASK_TEMPLATE
  WAREHOUSE_INSTANCE
  WAREHOUSE_ITEM
}

model Tag {
  id           String        @id @default(auto()) @map("_id") @db.ObjectId
  name         String        @unique
  type         TagType       @default(GENERAL)
  description  String?
  color        String?    
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt

  tagRelations TagRelation[] // è¬ç”¨é—œè¯

  @@index([type])
}

model TagRelation {
  id         String          @id @default(auto()) @map("_id") @db.ObjectId
  tagId      String          @db.ObjectId
  targetId   String          @db.ObjectId
  targetType TagRelationType
  createdAt  DateTime        @default(now())
  priority   Int             @default(0)

  tag        Tag             @relation(fields: [tagId], references: [id])

  @@unique([tagId, targetId, targetType])
  @@index([targetId, targetType])
}

model Asset {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  type          AssetEnum @unique
  name          String   
  description   String?  
  symbol        String?  
  iconUrl       String?  
  decimals      Int      @default(0)
  isActive      Boolean  @default(true)
  displayOrder  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

}

model UserAsset {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @unique
  diamonds     Int      @default(0)
  hearts       Int      @default(0)
  bubbles      Int      @default(0)
  coins        Int      @default(0)
  extraAssets  Json?    @default("{}")
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [userId])

}

model AssetMutation {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  userId      String        
  currency    AssetEnum
  amount      Int
  balance     Int           
  reason      TransactionEnum
  description String?
  createdAt   DateTime      @default(now())
  
  user        User          @relation(fields: [userId], references: [userId])

  @@index([userId, currency, createdAt]) 
  @@index([userId, reason, createdAt])
}

enum AssetEnum {
  DIAMOND
  HEART
  BUBBLE
  COIN
}

enum TransactionEnum {
  INCREASE
  DECREASE
  EXCHANGE
  REWARD
  TRANSFER
  BURN
}



/// é™„ä»¶æ¨¡å‹ï¼Œå®šç¾©å¯ä»¥æ›åœ¨å°ˆæ¡ˆæˆ–ä»»å‹™ä¸‹çš„æª”æ¡ˆé™„ä»¶
model Attachment {
  id String @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµï¼Œä½¿ç”¨ MongoDB ObjectIdï¼Œè‡ªå‹•ç”Ÿæˆ
  name String /// é™„ä»¶åç¨±
  url String /// é™„ä»¶æª”æ¡ˆç¶²å€
  uploadedBy String @db.ObjectId /// ä¸Šå‚³è€…çš„ä½¿ç”¨è€… IDï¼ˆå¤–éµï¼‰
  projectId String? @db.ObjectId /// æ‰€å±¬å°ˆæ¡ˆ IDï¼Œå¯ç‚ºç©ºï¼ˆå¤–éµï¼‰
  taskId String? @db.ObjectId /// æ‰€å±¬ä»»å‹™ IDï¼Œå¯ç‚ºç©ºï¼ˆå¤–éµï¼‰
  project ProjectInstance? @relation(fields: [projectId], references: [id]) /// é—œè¯åˆ°çš„å°ˆæ¡ˆï¼ˆé¸å¡«ï¼‰
  task TaskInstance? @relation(fields: [taskId], references: [id]) /// é—œè¯åˆ°çš„ä»»å‹™ï¼ˆé¸å¡«ï¼‰
  createdAt DateTime @default(now()) /// å»ºç«‹æ™‚é–“
}


model WarehouseInstance {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  location    String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  items       WarehouseItem[] // ä¿ç•™ï¼Œå› ç‚ºé€™æ˜¯å…§éƒ¨ç‰©å“ (ä¸€å°å¤š)
}

model WarehouseItem {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  quantity      Int               @default(0)
  unit          String?
  type          WarehouseItemType @default(TOOL) // ğŸ†• ç‰©å“é¡åˆ¥

  warehouseId   String            @db.ObjectId
  warehouse     WarehouseInstance @relation(fields: [warehouseId], references: [id])
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([type])
}

enum WarehouseItemType {
  TOOL      // å·¥å…·
  EQUIPMENT // è¨­å‚™
  CONSUMABLE // è€—æ
}

model LinePay {
  id                 String      @id @default(auto()) @map("_id") @db.ObjectId
  userId             String      
  transactionId      String?
  order_id           String      @unique
  currency           String
  amount             Int
  status             PaymentEnum
  packages           Json
  redirectUrls       Json?
  options            Json?
  paymentUrl         Json?
  paymentAccessToken String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  
  user               User        @relation(fields: [userId], references: [userId])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, createdAt])
}

enum PaymentEnum {
  PENDING
  SUCCESS
  FAILED
}


/// å°ˆæ¡ˆæ¨¡æ¿ï¼Œå®šç¾©ä¸€å€‹å®Œæ•´å·¥ç¨‹å°ˆæ¡ˆçš„åŸºç¤çµæ§‹
model ProjectTemplate {
  id          String               @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµï¼Œä½¿ç”¨ MongoDB ObjectIdï¼Œè‡ªå‹•ç”Ÿæˆ
  name        String /// å°ˆæ¡ˆæ¨¡æ¿åç¨±ï¼Œå¿…å¡«
  description String? /// å°ˆæ¡ˆæ¨¡æ¿æè¿°ï¼Œé¸å¡«
  priority    Int?                 @default(0) /// æ¨¡æ¿å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  createdAt   DateTime             @default(now()) /// å»ºç«‹æ™‚é–“ï¼Œè‡ªå‹•è¨­å®šç‚ºç›®å‰æ™‚é–“
  updatedAt   DateTime             @default(now()) /// æ›´æ–°æ™‚é–“ï¼Œè‡ªå‹•è¨­å®šç‚ºç›®å‰æ™‚é–“
}
/// å·¥ç¨‹æ¨¡æ¿ï¼Œå®šç¾©å·¥ç¨‹å±¤ç´šè³‡æ–™
model EngineeringTemplate {
  id          String               @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµ
  name        String /// å·¥ç¨‹æ¨¡æ¿åç¨±
  description String? /// å·¥ç¨‹æ¨¡æ¿æè¿°
  priority    Int?                 @default(0) /// å·¥ç¨‹æ¨¡æ¿å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  createdAt   DateTime             @default(now()) /// å»ºç«‹æ™‚é–“
  updatedAt   DateTime             @default(now()) /// æ›´æ–°æ™‚é–“
  
  // æ·»åŠ èˆ‡ TaskTemplate çš„é—œè¯
  taskTemplates TaskTemplate[] // è©²å·¥ç¨‹æ¨¡æ¿æ“æœ‰çš„ä»»å‹™æ¨¡æ¿
}
/// ä»»å‹™æ¨¡æ¿ï¼Œéš¸å±¬æ–¼æŸå€‹å·¥ç¨‹æ¨¡æ¿ï¼Œå®šç¾©å·¥ç¨‹å…§çš„ä»»å‹™
model TaskTemplate {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  priority      Int?               @default(0) /// å„ªå…ˆé †åº
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @default(now())
  
  // æ·»åŠ èˆ‡ EngineeringTemplate çš„é—œè¯ 
  engineeringTemplateId String?    @db.ObjectId // æ‰€å±¬å·¥ç¨‹æ¨¡æ¿ ID
  engineeringTemplate   EngineeringTemplate?  @relation(fields: [engineeringTemplateId], references: [id]) // æ‰€å±¬å·¥ç¨‹æ¨¡æ¿
}
/// å­ä»»å‹™æ¨¡æ¿æ¨¡å‹ï¼Œå®šç¾©ä»»å‹™æ¨¡æ¿ä¸­çš„å­ä»»å‹™çµæ§‹
model SubTaskTemplate {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµï¼Œä½¿ç”¨ MongoDB ObjectIdï¼Œè‡ªå‹•ç”Ÿæˆ
  name            String         /// å­ä»»å‹™æ¨¡æ¿åç¨±
  description     String?        /// å­ä»»å‹™æ¨¡æ¿æè¿°
  plannedStart    DateTime?      /// é è¨ˆé–‹å§‹æ™‚é–“
  plannedEnd      DateTime?      /// é è¨ˆçµæŸæ™‚é–“
  equipmentCount  Int?           /// é è¨ˆè¨­å‚™æ•¸é‡
  priority        Int?           @default(0) /// å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  status          String?        @default("pending") /// é è¨­å­ä»»å‹™æ¨¡æ¿ç‹€æ…‹
  completionRate  Float?         @default(0) /// é è¨­å®Œæˆç‡ï¼Œ0ï½100%
  isMandatory     Boolean        @default(true) /// æ˜¯å¦ç‚ºå¿…é ˆä»»å‹™ï¼Œé è¨­ç‚ºå¿…é ˆ
  orderIndex      Int?           @default(0) /// æ’å…¥é †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆ
  parentTemplateId String?       @db.ObjectId /// ä¾†æºæ¨¡æ¿ IDï¼Œç”¨æ–¼è¨˜éŒ„è¤‡è£½ä¾†æº
  createdAt       DateTime       @default(now()) /// å»ºç«‹æ™‚é–“
  updatedAt       DateTime       @default(now()) /// æ›´æ–°æ™‚é–“
}


/// å°ˆæ¡ˆæˆå“¡æ¨¡å‹ï¼Œå®šç¾©å°ˆæ¡ˆçš„æˆå“¡åŠå…¶è§’è‰²
model ProjectMember {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµï¼Œä½¿ç”¨ MongoDB ObjectIdï¼Œè‡ªå‹•ç”Ÿæˆ
  projectId String     @db.ObjectId /// æ‰€å±¬å°ˆæ¡ˆ ID
  userId    String     @db.ObjectId /// ä½¿ç”¨è€… ID
  role      MemberRole @default(MEMBER) /// æˆå“¡è§’è‰²ï¼Œé è¨­ç‚ºä¸€èˆ¬æˆå“¡
  priority   Int?       @default(0) /// æˆå“¡å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  joinedAt  DateTime   @default(now()) /// åŠ å…¥æ™‚é–“
  project   ProjectInstance @relation(fields: [projectId], references: [id]) /// æ‰€å±¬å°ˆæ¡ˆé—œè¯
  user      User       @relation(fields: [userId], references: [id]) /// ä½¿ç”¨è€…é—œè¯
  @@index([projectId, userId], name: "project_user_unique") /// å°ˆæ¡ˆèˆ‡ä½¿ç”¨è€…çµ„æˆå”¯ä¸€ç´¢å¼•
}
/// æˆå“¡è§’è‰²åˆ—èˆ‰å€¼
enum MemberRole {
  OWNER /// å°ˆæ¡ˆæ“æœ‰è€…
  ADMIN /// ç®¡ç†å“¡
  MEMBER /// ä¸€èˆ¬æˆå“¡
  VIEWER /// æª¢è¦–è€…
  CONTRIBUTOR /// è²¢ç»è€…
}
/// å°ˆæ¡ˆä¸»é«”æ¨¡å‹ï¼Œå®šç¾©ä¸€å€‹å¯¦éš›é‹è¡Œä¸­çš„å·¥ç¨‹å°ˆæ¡ˆ
model ProjectInstance {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµï¼Œä½¿ç”¨ MongoDB ObjectIdï¼Œè‡ªå‹•ç”Ÿæˆ
  name        String /// å°ˆæ¡ˆåç¨±ï¼Œå¿…å¡«
  description String? /// å°ˆæ¡ˆæè¿°ï¼Œé¸å¡«
  priority    Int?          @default(0) /// æ¨¡æ¿å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  startDate   DateTime /// å°ˆæ¡ˆé–‹å§‹æ—¥æœŸ
  endDate     DateTime? /// å°ˆæ¡ˆçµæŸæ—¥æœŸï¼Œé¸å¡«
  progress    Float         @default(0.0) /// å°ˆæ¡ˆæ•´é«”é€²åº¦ç™¾åˆ†æ¯”ï¼Œé è¨­ 0
  minQuantity Int           @default(1) /// æœ€ä½è¨­å‚™æ•¸é‡ï¼Œé è¨­ç‚º 1
  maxQuantity Int? /// æœ€é«˜è¨­å‚™æ•¸é‡ï¼Œé¸å¡«
  quantity    Int           @default(1) /// é è¨­è¨­å‚™æ•¸é‡ï¼Œé è¨­ç‚º 1
  createdBy   String        @db.ObjectId /// å»ºç«‹è€…ä½¿ç”¨è€… IDï¼ˆå¤–éµï¼‰
  creator     User          @relation("UserCreatedProjects", fields: [createdBy], references: [id]) /// å»ºç«‹è€…ï¼ˆUser é—œè¯ï¼‰
  createdAt   DateTime      @default(now()) /// å»ºç«‹æ™‚é–“
  updatedAt   DateTime      @default(now()) /// æ›´æ–°æ™‚é–“
  engineerings EngineeringInstance[] /// é—œè¯çš„å·¥ç¨‹æ¸…å–®
  tasks       TaskInstance[]        @relation("ProjectTasks") /// å°ˆæ¡ˆåº•ä¸‹çš„ä»»å‹™æ¸…å–®
  members     ProjectMember[] /// å°ˆæ¡ˆæˆå“¡æ¸…å–®
  attachments Attachment[] /// é™„ä»¶æ¸…å–®
}
/// å·¥ç¨‹æ¨¡å‹ï¼Œå°ˆæ¡ˆå…§çš„å·¥ç¨‹ç´°åˆ†å–®ä½
model EngineeringInstance {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµ
  name        String /// å·¥ç¨‹åç¨±
  description String? /// å·¥ç¨‹æè¿°
  projectId   String      @db.ObjectId /// æ‰€å±¬å°ˆæ¡ˆ ID
  project     ProjectInstance @relation(fields: [projectId], references: [id]) /// æ‰€å±¬å°ˆæ¡ˆé—œè¯
  tasks       TaskInstance[] /// å·¥ç¨‹åº•ä¸‹çš„ä»»å‹™æ¸…å–®
  userId      String      @db.ObjectId /// è² è²¬äººä½¿ç”¨è€… ID
  user        User        @relation(fields: [userId], references: [id]) /// è² è²¬äººé—œè¯
  priority    Int?        @default(0) /// å·¥ç¨‹å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  createdAt   DateTime    @default(now()) /// å»ºç«‹æ™‚é–“
  updatedAt   DateTime    @updatedAt /// æ›´æ–°æ™‚é–“
}
/// ä»»å‹™æ¨¡å‹ï¼Œå®šç¾©ä¸€å€‹å·¥ç¨‹å…§çš„å–®ä¸€ä»»å‹™
model TaskInstance {
  id                   String        @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµ
  name                 String /// ä»»å‹™åç¨±
  description          String? /// ä»»å‹™æè¿°
  plannedStart         DateTime? /// è¨ˆç•«é–‹å§‹æ™‚é–“
  plannedEnd           DateTime? /// è¨ˆç•«çµæŸæ™‚é–“
  equipmentCount       Int? /// é è¨ˆè¨­å‚™æ•¸é‡
  actualEquipmentCount Int?         @default(0) /// å¯¦éš›è¨­å‚™æ•¸é‡
  priority             Int?         @default(0) /// å„ªå…ˆé †åºï¼Œæ•¸å­—è¶Šå°å„ªå…ˆåº¦è¶Šé«˜
  status               String?      @default("pending") /// ä»»å‹™ç‹€æ…‹ï¼Œé è¨­ç‚ºå¾…è™•ç†
  completionRate       Float?       @default(0) /// ä»»å‹™å®Œæˆç‡ï¼Œ0ï½100%
  engineeringId        String        @db.ObjectId /// æ‰€å±¬å·¥ç¨‹ ID
  engineering          EngineeringInstance @relation(fields: [engineeringId], references: [id]) /// æ‰€å±¬å·¥ç¨‹é—œè¯
  projectId            String        @db.ObjectId /// æ‰€å±¬å°ˆæ¡ˆ ID
  project              ProjectInstance @relation("ProjectTasks", fields: [projectId], references: [id]) /// æ‰€å±¬å°ˆæ¡ˆé—œè¯
  createdAt            DateTime      @default(now()) /// å»ºç«‹æ™‚é–“
  updatedAt            DateTime      @updatedAt /// æ›´æ–°æ™‚é–“ï¼Œè‡ªå‹•æ›´æ–°
  subtasks             SubTaskInstance[] /// ä»»å‹™åº•ä¸‹çš„å­ä»»å‹™å¯¦ä¾‹æ¸…å–®
  attachments          Attachment[] /// ä»»å‹™é™„ä»¶æ¸…å–®
}
/// å­ä»»å‹™å¯¦ä¾‹æ¨¡å‹ï¼Œç´°åˆ†ä»»å‹™çš„æ›´å°æ­¥é©Ÿ
model SubTaskInstance {
  id                   String       @id @default(auto()) @map("_id") @db.ObjectId /// ä¸»éµ
  name                 String /// å­ä»»å‹™åç¨±
  description          String? /// å­ä»»å‹™æè¿°
  plannedStart         DateTime? /// é è¨ˆé–‹å§‹æ™‚é–“
  plannedEnd           DateTime? /// é è¨ˆçµæŸæ™‚é–“
  equipmentCount       Int? /// é è¨ˆè¨­å‚™æ•¸é‡
  actualEquipmentCount Int?         @default(0) /// å¯¦éš›è¨­å‚™æ•¸é‡
  startDate            DateTime? /// çœŸå¯¦é–‹å§‹æ™‚é–“
  endDate              DateTime? /// çœŸå¯¦çµæŸæ™‚é–“
  actualStart          DateTime? /// å¯¦éš›é–‹å§‹æ—¥æœŸ
  actualEnd            DateTime? /// å¯¦éš›çµæŸæ—¥æœŸ
  priority             Int?         @default(0) /// å„ªå…ˆé †åº
  status               String?      @default("pending") /// å­ä»»å‹™ç‹€æ…‹
  completionRate       Float?       @default(0) /// å­ä»»å‹™å®Œæˆç‡
  taskId               String       @db.ObjectId /// æ‰€å±¬ä»»å‹™ ID
  task                 TaskInstance @relation(fields: [taskId], references: [id]) /// æ‰€å±¬ä»»å‹™é—œè¯
  createdAt            DateTime     @default(now()) /// å»ºç«‹æ™‚é–“
  updatedAt            DateTime     @default(now()) /// æ›´æ–°æ™‚é–“
}